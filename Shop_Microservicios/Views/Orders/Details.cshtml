@model Shop_Microservicios.Models.ViewModels.Orders.OrderDetailsViewModel

@{
    ViewData["Title"] = $"Orden #{Model.Id}";

    string orderBadge = Model.Status == "PAID" ? "bg-success"
        : Model.Status == "CANCELLED" ? "bg-danger"
        : "bg-warning text-dark";
}

<div class="container mt-4">

    @* (Opcional) Mensaje de resultado del pago si llegas redirigido *@
    @if (ViewBag.PaymentStatus != null)
    {
        bool success = string.Equals((string)ViewBag.PaymentStatus, "APPROVED",
        System.StringComparison.OrdinalIgnoreCase);

        <div class="alert @(success ? "alert-success" : "alert-danger")" role="alert">
            @(success
                    ? $"✅ Pago realizado correctamente por {ViewBag.PaymentAmount} ({ViewBag.PaymentMethod})."
                    : "❌ El pago fue rechazado. Verifica los datos e intenta de nuevo.")
    </div>
        }

    <div class="row mb-4">
        <div class="col-md-8">
            <h2 class="mb-1">Orden #@Model.Id</h2>
            <p class="text-muted mb-0">
                <strong>Fecha:</strong> @Model.CreatedAt
            </p>
        </div>

        <div class="col-md-4 text-md-end mt-3 mt-md-0">
            <span class="badge @orderBadge" style="font-size:1rem;">
                Estado: @Model.Status
            </span>
        </div>
    </div>

    <div class="row mb-4">
        <!-- Resumen -->
        <div class="col-lg-6">
            <div class="card shadow-sm">
                <div class="card-body">
                    <h5 class="card-title mb-3">Resumen</h5>

                    <div class="d-flex justify-content-between mb-2">
                        <span>Total de la orden:</span>
                        <span class="fw-bold fs-5">@Model.TotalAmount.ToString("C")</span>
                    </div>

                    <small class="text-muted d-block mb-3">
                        Los precios incluyen los montos registrados al momento de la compra.
                    </small>

                    <hr />

                    <div class="d-flex gap-2">
                        @if (Model.Status == "PENDING")
                        {
                            <a class="btn btn-primary flex-fill"
                               asp-controller="Checkout"
                               asp-action="Address"
                               asp-route-orderId="@Model.Id">
                                Continuar checkout →
                            </a>

                            <form asp-controller="Orders"
                                  asp-action="Cancel"
                                  asp-route-id="@Model.Id"
                                  method="post"
                                  class="flex-fill">
                                @Html.AntiForgeryToken()
                                <button type="submit"
                                        class="btn btn-outline-danger w-100"
                                        onclick="return confirm('¿Seguro que deseas cancelar esta orden?');">
                                    Cancelar orden
                                </button>
                            </form>
                        }
                        else if (Model.Status == "PAID")
                        {
                            <span class="text-success fw-semibold">✅ Orden pagada.</span>
                        }
                        else if (Model.Status == "CANCELLED")
                        {
                            <span class="text-danger fw-semibold">❌ Orden cancelada.</span>
                        }
                    </div>
                </div>
            </div>
        </div>

        <!-- Info -->
        <div class="col-lg-6 mt-3 mt-lg-0">
            <div class="card shadow-sm">
                <div class="card-body">
                    <h5 class="card-title mb-3">Información</h5>
                    <ul class="mb-2">
                        <li>Para pagar debes completar el checkout (Dirección → Pago).</li>
                        <li>Las órdenes pendientes pueden cancelarse.</li>
                        <li>Una orden pagada no debería poder cancelarse.</li>
                    </ul>
                    <small class="text-muted">
                        Proyecto académico: pagos simulados.
                    </small>
                </div>
            </div>
        </div>
    </div>

    <h4 class="mb-3">Productos</h4>

    <div class="card shadow-sm">
        <div class="card-body p-0">
            <table class="table mb-0 align-middle">
                <thead class="table-light">
                    <tr>
                        <th style="width:50%;">Producto</th>
                        <th class="text-end" style="width:15%;">Precio unitario</th>
                        <th class="text-center" style="width:10%;">Cantidad</th>
                        <th class="text-end" style="width:15%;">Subtotal</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var item in Model.Items)
                    {
                        <tr>
                            <td>
                                <div class="d-flex align-items-center">
                                    @if (!string.IsNullOrEmpty(item.Thumbnail))
                                    {
                                        <img src="@item.Thumbnail"
                                             alt="@item.Title"
                                             class="img-thumbnail me-3"
                                             style="width:48px;height:48px;object-fit:cover;border-radius:50%;" />
                                    }
                                    <div>
                                        <div class="fw-semibold">@item.Title</div>
                                        <small class="text-muted">ID: @item.ProductId</small>
                                    </div>
                                </div>
                            </td>
                            <td class="text-end">@item.UnitPrice.ToString("C")</td>
                            <td class="text-center">@item.Quantity</td>
                            <td class="text-end">@item.LineTotal.ToString("C")</td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    </div>

    <div class="mt-4">
        <a asp-controller="Orders" asp-action="Index" class="btn btn-outline-secondary">
            ← Volver a mis órdenes
        </a>
        <a asp-controller="Home" asp-action="Index" class="btn btn-link">
            Seguir comprando
        </a>
    </div>
</div>
