@model List<Shop_Microservicios.Models.Api.Notification.NotificationDto>

@{
    ViewData["Title"] = "Notificaciones";
}

<div class="container mt-4">
    <h2 class="mb-3">🔔 Notificaciones</h2>

    @if (Model == null || !Model.Any())
    {
        <div class="alert alert-info">No tienes notificaciones.</div>
    }
    else
    {
        <div class="list-group" id="notifsList">
            @foreach (var n in Model.OrderByDescending(x => x.CreatedAt))
            {
                var isRead = string.Equals(n.Status, "READ", StringComparison.OrdinalIgnoreCase);
                var css = isRead ? "notif-read" : "notif-unread";

                <div class="list-group-item notif-item @css" data-id="@n.Id" id="notif-@n.Id">
                    <div class="d-flex justify-content-between align-items-start gap-3">
                        <div class="flex-grow-1">
                            <div class="fw-bold">@n.Title</div>
                            <div class="text-muted small">@n.Type · @n.CreatedAt.ToString("dd/MM/yyyy HH:mm")</div>
                            <div class="mt-2">@n.Message</div>
                            <div class="small text-secondary mt-2">Estado: <span class="notif-status">@n.Status</span></div>
                        </div>

                        <div class="ms-2">
                            @if (!isRead)
                            {
                                <form class="mark-read-form" asp-action="Read" asp-route-id="@n.Id" method="post">
                                    @Html.AntiForgeryToken()
                                    <button type="submit" class="btn btn-sm btn-outline-primary">
                                        Marcar como leída
                                    </button>
                                </form>
                            }
                        </div>
                    </div>
                </div>
            }
        </div>
    }
</div>

@section Scripts {
    <script>
        document.addEventListener("submit", async (e) => {
          const form = e.target;
          if (!form.classList.contains("mark-read-form")) return;

          e.preventDefault();

          const item = form.closest(".notif-item");
          const url = form.getAttribute("action");

          // Anti-forgery token
          const tokenInput = form.querySelector('input[name="__RequestVerificationToken"]');
          const token = tokenInput ? tokenInput.value : "";

          try {
            const resp = await fetch(url, {
              method: "POST",
              headers: {
                "Content-Type": "application/x-www-form-urlencoded"
              },
              body: new URLSearchParams({ "__RequestVerificationToken": token })
            });

            if (!resp.ok) {
              alert("No se pudo marcar como leída.");
              return;
            }

            // ✅ UI update: amarillo -> blanco, status -> READ, ocultar botón
            item.classList.remove("notif-unread");
            item.classList.add("notif-read");

            const statusSpan = item.querySelector(".notif-status");
            if (statusSpan) statusSpan.textContent = "READ";

            form.remove();

          } catch (err) {
            alert("Error de red marcando como leída.");
          }
        });
    </script>
}
